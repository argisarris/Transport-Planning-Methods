# Predict using the fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
summary(Strukturdaten$trips_work)
summary(df_work$n_work)
mc_mean_n <- mean(df_work$n_work); mc_var_n <- var(df_work$n_work) #mc = model check
message("mean=", round(mc_mean_n,3), " var=", round(mc_var_n,3),
" (", ifelse(mc_var_n > 1.5*mc_mean_n, "use NegBin", "Poisson ok"), ")")
mc_form <- n_work ~ n_age_0_17 + n_age_18_24 + n_age_25_44 +
n_age_45_64 + n_age_65_74 + n_age_75p +
car_group + pt_group
# Fit Poisson and check overdispersion
mc_m_pois <- glm(mc_form, family = poisson(), data = df_work)
mc_pearson_od <- sum(residuals(mc_m_pois, type = "pearson")^2) / df.residual(mc_m_pois)
cat("Mean =", round(mc_mean_n,3), " Var =", round(mc_var_n,3), "\n")
cat("Poisson Pearson overdispersion =", round(mc_pearson_od, 2), "\n")
# Fit Negative Binomial
mc_m_nb <- glm.nb(mc_form, data = df_work)
mc_theta <- mc_m_nb$theta
cat("NB theta =", round(mc_theta,3), "(higher ~ closer to Poisson; lower ~ more overdispersion)\n")
# Compare fit (LogLik & AIC)
mc_comp <- data.frame(
model = c("Poisson","NegBin"),
logLik = c(logLik(mc_m_pois), logLik(mc_m_nb)),
AIC    = c(AIC(mc_m_pois),    AIC(mc_m_nb))
)
print(mc_comp[order(mc_comp$AIC), ], row.names = FALSE)
# Likelihood-ratio comparison
anova(mc_m_pois, mc_m_nb, test = "Chisq")
# Parsimony checks (ANOVA)
anova(mc_m_nb, test = "Chisq")
# Coefficients as IRRs (incident rate ratios)
irr <- broom::tidy(mc_m_nb, exponentiate = TRUE, conf.int = TRUE)
print(irr[, c("term","estimate","conf.low","conf.high","p.value")])
### Save model objects
saveRDS(mc_m_pois, file = file.path(dir_models, "model_poisson.rds"))
saveRDS(mc_m_nb,   file = file.path(dir_models, "model_negbin.rds"))
### Save IRRs as CSV
write.csv(irr[, c("term","estimate","conf.low","conf.high","p.value")],
file = file.path(dir_models, "nb_model_IRRs.csv"), row.names = FALSE)
### Save model comparison table
write.csv(mc_comp, file = file.path(dir_models, "model_comparison.csv"), row.names = FALSE)
### Save work trip data used for model estimation
write.csv(df_work, file = file.path(dir_tables, "df_work_model_input.csv"), row.names = FALSE)
### Save cleaned household data for future use or validation
write.csv(df_hh_clean, file = file.path(dir_models, "df_hh_clean.csv"), row.names = FALSE)
### Save Poisson overdispersion test
overdisp_stats <- data.frame(
model = "Poisson",
mean_trips = mc_mean_n,
var_trips = mc_var_n,
pearson_overdispersion = mc_pearson_od
)
write.csv(overdisp_stats, file = file.path(dir_models, "poisson_overdispersion.csv"), row.names = FALSE)
### Save model ANOVA (NegBin)
anova_nb <- broom::tidy(anova(mc_m_nb, test = "Chisq"))
write.csv(anova_nb, file = file.path(dir_models, "nb_model_anova.csv"), row.names = FALSE)
# Rebuild predictor variables from existing columns
predict_data <- Strukturdaten %>%
transmute(
# Directly use known age groups
n_age_0_17  = R_0017,
n_age_18_24 = R_1824,
n_age_25_44 = R_2544,
n_age_45_64 = R_4564,
n_age_65_74 = R_6574,
n_age_75p   = R_75PLUS,
# Factor variables for car/PT availability
car_group = factor(if_else(HH_WITH_CAR > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(`WERTSTRUKTURGROESSE(SG_R_GATC)` + `WERTSTRUKTURGROESSE(SG_R_LTC)` > 0, "PT", "NO_PT"),
levels = c("NO_PT", "PT"))
)
# Print total population per age group (Step 6)
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using the fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
summary(Strukturdaten$trips_work)
# Max values of numeric predictors
sapply(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p",
)], max, na.rm = TRUE)
# Max values of numeric predictors
sapply(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p"
)], max, na.rm = TRUE)
predicted_values <- predict(mc_m_nb, newdata = predict_data, type = "response")
summary(predicted_values)
table(predict_data$car_group)
table(predict_data$pt_group)
# Rebuild predictor variables from disaggregated structural data
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across car/PT groups)
n_age_0_17  = R_0017_CARTC + R_0017_CARNOTC + R_0017_NOCTC + R_0017_NOCNOTC,
n_age_18_24 = R_1824_CARTC + R_1824_CARNOTC + R_1824_NOCTC + R_1824_NOCNOTC,
n_age_25_44 = R_2544_CARTC + R_2544_CARNOTC + R_2544_NOCTC + R_2544_NOCNOTC,
n_age_45_64 = R_4564_CARTC + R_4564_CARNOTC + R_4564_NOCTC + R_4564_NOCNOTC,
n_age_65_74 = R_6574_CARTC + R_6574_CARNOTC + R_6574_NOCTC + R_6574_NOCNOTC,
n_age_75p   = R_75XX_CARTC + R_75XX_CARNOTC + R_75XX_NOCTC + R_75XX_NOCNOTC,
# Intermediate variables for car and PT availability
car_available = R_0017_CARTC + R_0017_CARNOTC + R_1824_CARTC + R_1824_CARNOTC +
R_2544_CARTC + R_2544_CARNOTC + R_4564_CARTC + R_4564_CARNOTC +
R_6574_CARTC + R_6574_CARNOTC + R_75XX_CARTC + R_75XX_CARNOTC,
pt_available  = R_0017_CARTC + R_0017_NOCTC + R_1824_CARTC + R_1824_NOCTC +
R_2544_CARTC + R_2544_NOCTC + R_4564_CARTC + R_4564_NOCTC +
R_6574_CARTC + R_6574_NOCTC + R_75XX_CARTC + R_75XX_NOCTC,
# Create factor levels (ensuring both levels are available even if one has 0 count)
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"), levels = c("NO_PT",  "PT"))
)
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across car/PT groups)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Intermediate totals for determining group memberships
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Final factors used in model prediction
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
)
# Print total population per age group to check inputs
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using the fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
# Merge into spatial layer
npvm_zones_ZH$trips_work     <- Strukturdaten$trips_work
npvm_zones_ZH$attractor_work <- Strukturdaten$FTE
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
### Step 6a: Visualize and Save Plots
# Plot 1: Work trip production
p1 <- ggplot() +
geom_sf(data = npvm_zones_ZH, aes(fill = trips_work)) +
scale_fill_gradient(low = "lightyellow", high = "red") +
labs(title = "Predicted Work Trips per Zone", fill = "Trips")
ggsave(file.path(dir_figures, "predicted_trips_work.png"), plot = p1, width = 8, height = 6)
summary(predicted_values)
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across car/PT groups)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Intermediate totals for determining group memberships
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Final factors used in model prediction
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
)
mutate(
car_group = factor(car_group, levels = c("NO_CAR", "CAR")),
pt_group  = factor(pt_group,  levels = c("NO_PT",  "PT"))
)
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across car/PT groups)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Intermediate totals for determining group memberships
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Final factors used in model prediction
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
) %>%
mutate(
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"),
levels = c("NO_CAR", "CAR")),
pt_group = factor(if_else(pt_available > 0, "PT", "NO_PT"),
levels = c("NO_PT", "PT"))
)
# Print total population per age group to check inputs
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using the fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
summary(predicted_values)
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across all car/PT access combinations)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Car availability: CARTC and CARNOTC = has car
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
# PT availability: CARTC and NOCTC = has PT pass
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Categorical factors for model
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
)
# Optional: Print total people by age group (for validation)
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("✅ Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
# Check for extreme values (optional)
summary(Strukturdaten$trips_work)
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across all car/PT access combinations)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Car availability: CARTC and CARNOTC = has car
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
# PT availability: CARTC and NOCTC = has PT pass
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Categorical factors for model
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
) %>%
mutate(
car_group = factor(car_group, levels = c("NO_CAR", "CAR")),
pt_group  = factor(pt_group,  levels = c("NO_PT", "PT"))
)
# Optional: Print total people by age group (for validation)
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("✅ Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
# Check for extreme values (optional)
summary(Strukturdaten$trips_work)
levels(predict_data$car_group)
levels(predict_data$pt_group)
table(predict_data$car_group, useNA = "ifany")
table(predict_data$pt_group, useNA = "ifany")
# Predict using fitted Negative Binomial model
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data, type = "response")
summary(Strukturdaten$trips_work)
model.matrix(~ ., data = predict_data) %>% colnames()
model.matrix(mc_m_nb) %>% colnames()
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across all car/PT access combinations)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Car availability: CARTC and CARNOTC = has car
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
# PT availability: CARTC and NOCTC = has PT pass
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Categorical factors for model
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
) %>%
mutate(
car_group = factor(car_group, levels = c("NO_CAR", "CAR")),
pt_group  = factor(pt_group,  levels = c("NO_PT", "PT"))
)
levels(predict_data$car_group)
levels(predict_data$pt_group)
table(predict_data$car_group, useNA = "ifany")
table(predict_data$pt_group, useNA = "ifany")
# Optional: Print total people by age group (for validation)
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("✅ Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using fitted Negative Binomial model
# Keep only columns used in the model
predict_data_model <- predict_data %>%
select(all_of(all.vars(formula(mc_m_nb))))
# Predict using fitted Negative Binomial model
# Keep only columns used in the model
predict_data_model <- dplyr::select(predict_data, all_of(all.vars(formula(mc_m_nb))))
predict_data <- Strukturdaten %>%
transmute(
# Total persons per age group (sum across all car/PT access combinations)
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Car availability: CARTC and CARNOTC = has car
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
# PT availability: CARTC and NOCTC = has PT pass
pt_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Categorical factors for model
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"),  levels = c("NO_PT", "PT"))
) %>%
mutate(
car_group = factor(car_group, levels = c("NO_CAR", "CAR")),
pt_group  = factor(pt_group,  levels = c("NO_PT", "PT"))
)
levels(predict_data$car_group)
levels(predict_data$pt_group)
table(predict_data$car_group, useNA = "ifany")
table(predict_data$pt_group, useNA = "ifany")
# Optional: Print total people by age group (for validation)
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("✅ Total people assigned to model by age group:\n")
print(age_group_totals)
# Predict using fitted Negative Binomial model
# Keep only columns used in the model
predict_data_model <- dplyr::select(predict_data, all_of(all.vars(formula(mc_m_nb))))
# Run prediction
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data_model, type = "response")
# Build predictor data from detailed age × mode access categories
predict_data <- Strukturdaten %>%
transmute(
# Age groups - totals per category
n_age_0_17 = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_0017_NOCTC)` + `ANZPERSONEN(R_0017_NOCNOTC)`,
n_age_18_24 = `ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_1824_NOCTC)` + `ANZPERSONEN(R_1824_NOCNOTC)`,
n_age_25_44 = `ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_2544_NOCTC)` + `ANZPERSONEN(R_2544_NOCNOTC)`,
n_age_45_64 = `ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_4564_NOCTC)` + `ANZPERSONEN(R_4564_NOCNOTC)`,
n_age_65_74 = `ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_6574_NOCTC)` + `ANZPERSONEN(R_6574_NOCNOTC)`,
n_age_75p   = `ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)` +
`ANZPERSONEN(R_75XX_NOCTC)` + `ANZPERSONEN(R_75XX_NOCNOTC)`,
# Intermediate counts to determine mode access groupings
car_available = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_CARNOTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_CARNOTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_CARNOTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_CARNOTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_CARNOTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_CARNOTC)`,
pt_available  = `ANZPERSONEN(R_0017_CARTC)` + `ANZPERSONEN(R_0017_NOCTC)` +
`ANZPERSONEN(R_1824_CARTC)` + `ANZPERSONEN(R_1824_NOCTC)` +
`ANZPERSONEN(R_2544_CARTC)` + `ANZPERSONEN(R_2544_NOCTC)` +
`ANZPERSONEN(R_4564_CARTC)` + `ANZPERSONEN(R_4564_NOCTC)` +
`ANZPERSONEN(R_6574_CARTC)` + `ANZPERSONEN(R_6574_NOCTC)` +
`ANZPERSONEN(R_75XX_CARTC)` + `ANZPERSONEN(R_75XX_NOCTC)`,
# Model grouping factors
car_group = factor(if_else(car_available > 0, "CAR", "NO_CAR"), levels = c("NO_CAR", "CAR")),
pt_group  = factor(if_else(pt_available  > 0, "PT",  "NO_PT"),  levels = c("NO_PT",  "PT"))
)
# ---- Optional: Print total population per age group to validate
age_group_totals <- colSums(predict_data[, c("n_age_0_17", "n_age_18_24", "n_age_25_44",
"n_age_45_64", "n_age_65_74", "n_age_75p")],
na.rm = TRUE)
cat("✅ Total people assigned to model by age group:\n")
print(age_group_totals)
# ---- Important: Keep only model-relevant columns for prediction
predict_data_model <- dplyr::select(predict_data, all_of(all.vars(formula(mc_m_nb))))
# ---- Important: Keep only predictor variables (exclude response var)
predict_vars <- labels(terms(mc_m_nb))  # exclude "n_work"
predict_data_model <- dplyr::select(predict_data, all_of(predict_vars))
# ---- Predict work trips
Strukturdaten$trips_work <- predict(mc_m_nb, newdata = predict_data_model, type = "response")
# ---- Check summary
cat("\n✅ Summary of predicted trips_work:\n")
summary(Strukturdaten$trips_work)
colSums(is.na(predict_data_model))
cat("Model car_group levels:\n")
print(levels(df_work$car_group))
cat("Predict data car_group levels:\n")
print(levels(predict_data_model$car_group))
cat("Model pt_group levels:\n")
print(levels(df_work$pt_group))
cat("Predict data pt_group levels:\n")
print(levels(predict_data_model$pt_group))
predict(mc_m_nb, newdata = predict_data_model[1, ], type = "response")
